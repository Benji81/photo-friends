{% extends "app/base.html" %}
{% load django_bootstrap5 %}

{% block content %}
    <div class="container">

        <div class="col-md-4 offset-md-4">
            <div class="text-center">
                OBJ {{ object }}
            </div>

        </div>
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center">
                <div class="card">
                    <div class="card-header">
                        Please select one or more photo to upload
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data"{% comment %} onsubmit="showProgress();"{% endcomment %}>
                            {% csrf_token %}
                            <div class="form-group">

                                <label for="id_uploader">Name</label>
                                <input type="text" name="uploader" title="Uploader" required
                                       id="id_uploader" class="form-control"/>
                                <input type="file" name="files" multiple="" class="form-control-file" title="" required
                                       id="id_files" onchange="uploadFile();" hidden/>
                                <label id="upload-label" for="id_files">
                                    <span class="text-center">
                                        <i class="fas fa-file-csv fa-5x csv-icon"> Add Photos</i>
                                    </span>
                                </label>

                                <progress id="progressBar" class="progress is-info" value="0" max="100" style="width:100%;"></progress>
                                <div id="status"></div>
                            </div>
                        </form>
                        <div class="progress" id="progress" style="display: none">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                 role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"
                                 style="width: 100%">Uploading</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-12 text-center">
                <div class="card">
                    <div class="card-header">
                        Download the Album
                    </div>
                    <div class="card-body">
                        <a href="{% url "download" object.id %}" role="button" class="btn btn-outline-primary">Download</a>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-sm-12 text-center">
                <div class="card">
                    <div class="card-header">
                        Link to this Album
                    </div>
                    <div class="card-body">
                        <button id="copy" onclick="copyLink();">Copy</button>
                        <button id="share">Share</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row row-cols-auto">
            {% for upload in uploads %}
                <div class="col-md-2 col-xs-6 col-sm-6 text-center">
                    <a href="{{ upload.photo.url }}" class="">
                        <img class="img-fluid img-thumbnail" src="{{upload.thumbnail.url}}" alt="Photo">
                    </a>
                    <div class="uploader">
                        From {{ upload.uploader }}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>


    <script>


        function _(el) {
            return document.getElementById(el);
        }

        function uploadFile() {
            const files = _("id_files").files;
            const csrf = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            const uploader = document.getElementsByName("uploader")[0].value;

            const formdata = new FormData();
            formdata.append("csrfmiddlewaretoken", csrf);
            formdata.append("id_uploader", uploader);
            for (let i = 0; i < files.length; i++) {
                formdata.append("files", files[i]);
            }
            const ajax = new XMLHttpRequest();
            ajax.upload.addEventListener("progress", progressHandler, false);
            ajax.onload = function(){
                _("progressBar").value = 0;
                window.location.href = ajax.responseURL;
            };
            ajax.addEventListener("error", errorHandler, false);
            ajax.addEventListener("abort", abortHandler, false);
            ajax.open("POST", "?");
            ajax.send(formdata);
        }

        function progressHandler(event) {
            const percent = (event.loaded / event.total) * 100;
            _("progressBar").value = Math.round(percent);
            _("status").innerHTML = Math.round(percent) + "% uploaded... please wait";
        }

        function errorHandler(event) {
            _("status").innerHTML = "Upload Failed";
        }

        function abortHandler(event) {
            _("status").innerHTML = "Upload Aborted";
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
        }

        const shareButton = _("share");
        shareButton.addEventListener('click', event => {
            if (navigator.share) {
                navigator.share({
                    title: 'Sharing Album {{ object.name }}',
                    url: window.location.href
                }).then(() => {
                })
                    .catch(console.error);
            } else {
            }
        });


        if (navigator.share){
            _("copy").hidden = true;
            _("share").hidden = false;
        }else{
            _("copy").hidden = false;
            _("share").hidden = true;
        }
    </script>
{% endblock %}
